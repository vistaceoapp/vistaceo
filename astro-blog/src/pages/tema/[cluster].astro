---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getPostsByCluster } from '../../lib/supabase';
import { getAllClusters, getCluster } from '../../lib/clusters';
import { generateCollectionPageSchema, generateOrganizationSchema } from '../../lib/seo';
import { formatDate, truncate } from '../../lib/text';

export async function getStaticPaths() {
  const clusters = getAllClusters();
  
  return clusters.map((cluster) => ({
    params: { cluster: cluster.slug },
  }));
}

const { cluster: clusterSlug } = Astro.params;
const cluster = getCluster(clusterSlug);

if (!cluster) {
  return Astro.redirect('/404');
}

const posts = await getPostsByCluster(clusterSlug);

const siteUrl = 'https://blog.vistaceo.com';
const clusterUrl = `${siteUrl}/tema/${cluster.slug}`;

const schemas = [
  generateCollectionPageSchema(cluster.name, clusterUrl, posts),
  generateOrganizationSchema()
];
---

<BaseLayout 
  title={`${cluster.emoji} ${cluster.name} | VistaCEO Blog`}
  description={cluster.description}
  canonical={clusterUrl}
  schemas={schemas}
>
  <Header />
  
  <main class="cluster-hub">
    <header class="cluster-header">
      <div class="cluster-emoji">{cluster.emoji}</div>
      <h1><span class="text-gradient">{cluster.name}</span></h1>
      <p class="cluster-intro">{cluster.intro}</p>
    </header>
    
    {posts.length > 0 ? (
      <section>
        <h2 class="section-title">
          <span>üìö Art√≠culos ({posts.length})</span>
        </h2>
        <div class="posts-grid">
          {posts.map((post) => (
            <a href={`/${post.slug}`} class="post-card">
              {post.hero_image_url && (
                <div class="post-card-image">
                  <img 
                    src={post.hero_image_url} 
                    alt={post.image_alt_text || post.title}
                    loading="lazy"
                  />
                </div>
              )}
              <div class="post-card-content">
                <h3 class="post-card-title">{post.title}</h3>
                {post.excerpt && (
                  <p class="post-card-excerpt">{truncate(post.excerpt, 100)}</p>
                )}
                <span class="post-card-meta">{formatDate(post.publish_at)}</span>
              </div>
            </a>
          ))}
        </div>
      </section>
    ) : (
      <section class="empty-state">
        <div class="empty-icon">üìù</div>
        <p class="empty-text">
          Pr√≥ximamente publicaremos art√≠culos sobre {cluster.name}.
        </p>
        <a href="/" class="empty-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Volver al inicio
        </a>
      </section>
    )}
  </main>
  
  <Footer />
</BaseLayout>

<style>
  .empty-state {
    text-align: center;
    padding: 5rem 0;
  }
  
  .empty-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
  }
  
  .empty-text {
    color: var(--foreground-muted);
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
  }
  
  .empty-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary);
    font-weight: 600;
    transition: color var(--transition-fast);
  }
  
  .empty-link:hover {
    color: var(--accent);
  }
</style>
