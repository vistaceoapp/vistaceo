---
/**
 * ReadingToolbar - Experiencia de Lectura Premium
 * Toolbar sticky con barra de progreso, navegaci√≥n y acciones r√°pidas
 * Dise√±ado para UX ultra-premium en blog.vistaceo.com
 */

interface Props {
  postTitle: string;
  postUrl: string;
  headings: { text: string; id: string; level: number }[];
}

const { postTitle, postUrl, headings } = Astro.props;

// Secciones especiales del Prompt Maestro - EN ESPA√ëOL
const specialSections = [
  { pattern: /en\s*\d+\s*minutos?/i, label: '‚è±Ô∏è Resumen', color: 'blue' },
  { pattern: /por\s*qu[e√©]\s*(esto\s*)?(importa|matters)/i, label: 'üéØ Importancia', color: 'purple' },
  { pattern: /checklist|lista\s*de\s*verificaci[o√≥]n/i, label: '‚úÖ Checklist', color: 'green' },
  { pattern: /faq|preguntas?\s*frecuentes?/i, label: '‚ùì FAQ', color: 'pink' },
  { pattern: /pasos?|paso\s*a\s*paso|c[o√≥]mo\s*empezar/i, label: 'üìã Pasos', color: 'orange' },
  { pattern: /herramientas?|tools|recursos?/i, label: 'üõ†Ô∏è Recursos', color: 'cyan' },
  { pattern: /errores?\s*(comunes?|t[i√≠]picos?)/i, label: '‚ö†Ô∏è Errores', color: 'red' },
  { pattern: /plantilla|template/i, label: 'üìù Plantilla', color: 'indigo' },
  { pattern: /ejercicio|pr[a√°]ctica/i, label: 'üí™ Ejercicio', color: 'lime' },
  { pattern: /conclusi[o√≥]n|resumen|cierre|pr[o√≥]ximos?\s*pasos?/i, label: 'üöÄ Conclusi√≥n', color: 'violet' },
];

// Encontrar secciones especiales en los headings
const sectionShortcuts = headings
  .map(h => {
    const special = specialSections.find(s => s.pattern.test(h.text));
    if (special) {
      return { ...h, ...special };
    }
    return null;
  })
  .filter(Boolean)
  .slice(0, 6); // M√°ximo 6 para no saturar
---

<!-- Barra de Progreso Superior -->
<div id="reading-progress-container" class="progress-container">
  <div id="reading-progress-bar" class="progress-bar"></div>
</div>

<!-- Sidebar Desktop (Derecha) -->
<aside id="reading-toolbar-desktop" class="toolbar-desktop">
  <div class="toolbar-inner">
    <!-- Indicador de progreso circular -->
    <div class="progress-circle">
      <svg viewBox="0 0 36 36" class="circular-progress">
        <path class="bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
        <path id="progress-arc" class="progress" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
      </svg>
      <span id="progress-percent" class="progress-text">0%</span>
    </div>
    
    <!-- Atajos de secci√≥n -->
    {sectionShortcuts.length > 0 && (
      <div class="section-shortcuts">
        <span class="shortcuts-label">Ir a secci√≥n</span>
        {sectionShortcuts.map((section) => (
          <button 
            class={`shortcut-btn shortcut-${section.color}`}
            data-target={section.id}
            title={section.text}
          >
            {section.label}
          </button>
        ))}
      </div>
    )}
    
    <!-- Divisor -->
    <div class="toolbar-divider"></div>
    
    <!-- Acciones r√°pidas -->
    <div class="quick-actions">
      <button id="share-btn-desktop" class="action-btn" title="Compartir art√≠culo">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"/>
          <circle cx="6" cy="12" r="3"/>
          <circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        <span class="action-label">Compartir</span>
      </button>
      <button id="scroll-top-btn-desktop" class="action-btn" title="Volver arriba">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 15l-6-6-6 6"/>
        </svg>
        <span class="action-label">Arriba</span>
      </button>
    </div>
  </div>
</aside>

<!-- Barra M√≥vil Inferior -->
<div id="reading-toolbar-mobile" class="toolbar-mobile">
  <div class="mobile-inner">
    <!-- Progreso mini -->
    <div class="mobile-progress">
      <span id="mobile-progress-text" class="mobile-progress-text">0%</span>
      <span class="mobile-progress-label">le√≠do</span>
    </div>
    
    <!-- Chips de secci√≥n (scrollable) -->
    {sectionShortcuts.length > 0 && (
      <div class="mobile-chips">
        {sectionShortcuts.map((section) => (
          <button 
            class={`mobile-chip chip-${section.color}`}
            data-target={section.id}
          >
            {section.label}
          </button>
        ))}
      </div>
    )}
    
    <!-- Acciones -->
    <div class="mobile-actions">
      <button id="share-btn-mobile" class="mobile-action" title="Compartir">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"/>
          <circle cx="6" cy="12" r="3"/>
          <circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
      </button>
      <button id="scroll-top-btn-mobile" class="mobile-action" title="Arriba">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 15l-6-6-6 6"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<style>
  /* ===== BARRA DE PROGRESO (SUPERIOR) ===== */
  .progress-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--muted);
    z-index: 1000;
  }
  
  .progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #2692DC, #746CE6);
    transition: width 0.1s ease-out;
    box-shadow: 0 0 10px rgba(38, 146, 220, 0.5);
  }
  
  /* ===== SIDEBAR DESKTOP ===== */
  .toolbar-desktop {
    display: none;
    position: fixed;
    right: 28px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 100;
  }
  
  @media (min-width: 1280px) {
    .toolbar-desktop {
      display: block;
    }
  }
  
  .toolbar-inner {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px);
  }
  
  /* C√≠rculo de progreso */
  .progress-circle {
    position: relative;
    width: 56px;
    height: 56px;
  }
  
  .circular-progress {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }
  
  .circular-progress .bg {
    fill: none;
    stroke: var(--muted);
    stroke-width: 3;
  }
  
  .circular-progress .progress {
    fill: none;
    stroke: url(#gradient);
    stroke-width: 3;
    stroke-linecap: round;
    transition: stroke-dasharray 0.3s ease;
  }
  
  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: 700;
    color: var(--foreground);
  }
  
  /* Atajos de secci√≥n */
  .section-shortcuts {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  
  .shortcuts-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--foreground-muted);
    text-align: center;
    margin-bottom: 4px;
    font-weight: 600;
  }
  
  .shortcut-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 12px;
    font-size: 12px;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  .shortcut-blue { background: rgba(38, 146, 220, 0.15); color: #2692DC; }
  .shortcut-green { background: rgba(34, 197, 94, 0.15); color: #22C55E; }
  .shortcut-purple { background: rgba(116, 108, 230, 0.15); color: #746CE6; }
  .shortcut-orange { background: rgba(249, 115, 22, 0.15); color: #F97316; }
  .shortcut-cyan { background: rgba(6, 182, 212, 0.15); color: #06B6D4; }
  .shortcut-pink { background: rgba(236, 72, 153, 0.15); color: #EC4899; }
  .shortcut-red { background: rgba(239, 68, 68, 0.15); color: #EF4444; }
  .shortcut-indigo { background: rgba(99, 102, 241, 0.15); color: #6366F1; }
  .shortcut-lime { background: rgba(132, 204, 22, 0.15); color: #84CC16; }
  .shortcut-violet { background: rgba(139, 92, 246, 0.15); color: #8B5CF6; }
  
  .shortcut-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .toolbar-divider {
    width: 80%;
    height: 1px;
    background: var(--border);
  }
  
  /* Acciones r√°pidas */
  .quick-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }
  
  .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 12px;
    border: none;
    border-radius: 10px;
    background: var(--muted);
    color: var(--foreground-muted);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 11px;
    font-weight: 600;
  }
  
  .action-label {
    display: none;
  }
  
  @media (min-width: 1400px) {
    .action-label {
      display: inline;
    }
  }
  
  .action-btn:hover {
    background: var(--primary);
    color: white;
    transform: scale(1.05);
  }
  
  /* ===== BARRA M√ìVIL INFERIOR ===== */
  .toolbar-mobile {
    display: block;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: var(--card);
    border-top: 1px solid var(--border);
    padding: 12px 16px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.12);
    backdrop-filter: blur(16px);
    transform: translateY(100%);
    opacity: 0;
    transition: all 0.3s ease;
  }
  
  .toolbar-mobile.visible {
    transform: translateY(0);
    opacity: 1;
  }
  
  @media (min-width: 1280px) {
    .toolbar-mobile {
      display: none;
    }
  }
  
  .mobile-inner {
    display: flex;
    align-items: center;
    gap: 16px;
    max-width: 700px;
    margin: 0 auto;
  }
  
  .mobile-progress {
    flex-shrink: 0;
    min-width: 52px;
    padding: 8px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #2692DC, #746CE6);
    border-radius: 12px;
  }
  
  .mobile-progress-text {
    font-size: 14px;
    font-weight: 700;
    color: white;
    line-height: 1;
  }
  
  .mobile-progress-label {
    font-size: 9px;
    color: rgba(255, 255, 255, 0.8);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .mobile-chips {
    flex: 1;
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 4px 0;
  }
  
  .mobile-chips::-webkit-scrollbar {
    display: none;
  }
  
  .mobile-chip {
    flex-shrink: 0;
    padding: 8px 14px;
    font-size: 13px;
    font-weight: 600;
    border: none;
    border-radius: 24px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  .chip-blue { background: rgba(38, 146, 220, 0.15); color: #2692DC; }
  .chip-green { background: rgba(34, 197, 94, 0.15); color: #22C55E; }
  .chip-purple { background: rgba(116, 108, 230, 0.15); color: #746CE6; }
  .chip-orange { background: rgba(249, 115, 22, 0.15); color: #F97316; }
  .chip-cyan { background: rgba(6, 182, 212, 0.15); color: #06B6D4; }
  .chip-pink { background: rgba(236, 72, 153, 0.15); color: #EC4899; }
  .chip-red { background: rgba(239, 68, 68, 0.15); color: #EF4444; }
  .chip-indigo { background: rgba(99, 102, 241, 0.15); color: #6366F1; }
  .chip-lime { background: rgba(132, 204, 22, 0.15); color: #84CC16; }
  .chip-violet { background: rgba(139, 92, 246, 0.15); color: #8B5CF6; }
  
  .mobile-chip:active {
    transform: scale(0.95);
  }
  
  .mobile-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }
  
  .mobile-action {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 46px;
    height: 46px;
    border: none;
    border-radius: 12px;
    background: var(--muted);
    color: var(--foreground-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .mobile-action:active {
    background: var(--primary);
    color: white;
  }
</style>

<!-- Definici√≥n del gradiente SVG -->
<svg width="0" height="0" style="position: absolute;">
  <defs>
    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#2692DC"/>
      <stop offset="100%" style="stop-color:#746CE6"/>
    </linearGradient>
  </defs>
</svg>

<script define:vars={{ postTitle, postUrl }}>
  document.addEventListener('DOMContentLoaded', () => {
    const progressBar = document.getElementById('reading-progress-bar');
    const progressArc = document.getElementById('progress-arc');
    const progressPercent = document.getElementById('progress-percent');
    const mobileProgressText = document.getElementById('mobile-progress-text');
    const toolbarMobile = document.getElementById('reading-toolbar-mobile');
    const article = document.querySelector('.post-article');
    
    // Actualizar progreso en scroll
    function updateProgress() {
      if (!article) return;
      
      const articleRect = article.getBoundingClientRect();
      const articleTop = articleRect.top + window.scrollY;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;
      const scrollY = window.scrollY;
      
      // Calcular progreso
      const start = articleTop - windowHeight / 2;
      const end = articleTop + articleHeight - windowHeight / 2;
      const current = scrollY - start;
      const total = end - start;
      const progress = Math.min(Math.max(current / total * 100, 0), 100);
      
      // Actualizar barra de progreso
      if (progressBar) progressBar.style.width = progress + '%';
      
      // Actualizar c√≠rculo
      if (progressArc) progressArc.setAttribute('stroke-dasharray', `${progress}, 100`);
      if (progressPercent) progressPercent.textContent = Math.round(progress) + '%';
      if (mobileProgressText) mobileProgressText.textContent = Math.round(progress) + '%';
      
      // Mostrar/ocultar toolbar m√≥vil
      if (toolbarMobile) {
        if (scrollY > 250) {
          toolbarMobile.classList.add('visible');
        } else {
          toolbarMobile.classList.remove('visible');
        }
      }
    }
    
    // Throttle scroll
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateProgress();
          ticking = false;
        });
        ticking = true;
      }
    });
    
    // Actualizaci√≥n inicial
    updateProgress();
    
    // Navegaci√≥n a secciones
    document.querySelectorAll('[data-target]').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const target = document.getElementById(targetId);
        if (target) {
          const offset = 100; // Offset para el header
          const targetPosition = target.getBoundingClientRect().top + window.scrollY - offset;
          window.scrollTo({ top: targetPosition, behavior: 'smooth' });
        }
      });
    });
    
    // Scroll al inicio
    document.querySelectorAll('#scroll-top-btn-desktop, #scroll-top-btn-mobile').forEach(btn => {
      btn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
    
    // Funcionalidad de compartir
    async function sharePost() {
      if (navigator.share) {
        try {
          await navigator.share({
            title: postTitle,
            url: postUrl
          });
        } catch (err) {
          // Usuario cancel√≥
        }
      } else {
        // Fallback: copiar al portapapeles
        try {
          await navigator.clipboard.writeText(postUrl);
          // Mostrar feedback visual
          const btn = document.activeElement;
          if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úì ¬°Copiado!';
            setTimeout(() => {
              btn.innerHTML = originalText;
            }, 2000);
          }
        } catch (err) {
          // Fallback final
          prompt('Copi√° este enlace:', postUrl);
        }
      }
    }
    
    document.querySelectorAll('#share-btn-desktop, #share-btn-mobile').forEach(btn => {
      btn.addEventListener('click', sharePost);
    });
  });
</script>
