---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ToC from '../components/ToC.astro';
import PostMeta from '../components/PostMeta.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import type { BlogPost } from '../lib/supabase';
import { getMetaTitle, getMetaDescription, getOgImage, getCanonicalUrl, generateBlogPostingSchema, generateBreadcrumbSchema, generateArticleSchema } from '../lib/seo';
import { extractHeadings } from '../lib/text';

interface Props {
  post: BlogPost;
  relatedPosts: BlogPost[];
}

const { post, relatedPosts } = Astro.props;

const MAIN_SITE = 'https://www.vistaceo.com';
const title = getMetaTitle(post);
const description = getMetaDescription(post);
const canonical = getCanonicalUrl(post.slug);
const ogImage = getOgImage(post);
const headings = extractHeadings(post.content_md);

const schemas = [
  generateBlogPostingSchema(post),
  generateBreadcrumbSchema(post),
  generateArticleSchema(post)
];
---

<BaseLayout 
  title={title}
  description={description}
  canonical={canonical}
  ogImage={ogImage}
  ogType="article"
  publishedTime={post.publish_at || undefined}
  modifiedTime={post.updated_at}
  author={post.author_name || "Equipo VistaCEO"}
  schemas={schemas}
>
  <Header />
  
  <main class="post-main">
    <article class="post-article" itemscope itemtype="https://schema.org/BlogPosting">
      <!-- Hidden structured data -->
      <meta itemprop="headline" content={post.title}>
      <meta itemprop="datePublished" content={post.publish_at || post.created_at}>
      <meta itemprop="dateModified" content={post.updated_at}>
      <meta itemprop="author" content={post.author_name || "Equipo VistaCEO"}>
      
      <header class="post-header">
        <h1 itemprop="name">{post.title}</h1>
        <PostMeta post={post} />
      </header>
      
      {post.excerpt && (
        <div class="post-takeaways">
          <h2>üìå Puntos Clave</h2>
          <p>{post.excerpt}</p>
        </div>
      )}
      
      {headings.length > 2 && (
        <ToC headings={headings} />
      )}
      
      <div class="post-content" itemprop="articleBody" set:html={post.content_md} />
      
      <footer class="post-footer">
        <!-- Author box -->
        <div class="author-box">
          <div class="author-avatar">
            <span>‚úçÔ∏è</span>
          </div>
          <div class="author-info">
            <span class="author-label">Escrito por</span>
            <strong class="author-name">{post.author_name || "Equipo VistaCEO"}</strong>
            {post.author_bio && (
              <p class="author-bio">{post.author_bio}</p>
            )}
          </div>
        </div>
        
        <!-- CTA -->
        <div class="post-cta">
          <h3>¬øQuer√©s tomar mejores decisiones de negocio?</h3>
          <p>VistaCEO es tu copiloto de IA para PyMEs latinoamericanas. Probalo gratis.</p>
          <a href={`${MAIN_SITE}/auth`} class="cta-button">
            Conocer VistaCEO
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </a>
        </div>
        
        <!-- Share -->
        <div class="share-section">
          <span class="share-label">Compartir:</span>
          <div class="share-buttons">
            <a 
              href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(canonical)}&text=${encodeURIComponent(post.title)}`}
              target="_blank"
              rel="noopener"
              class="share-btn"
              aria-label="Compartir en Twitter"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </a>
            <a 
              href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(canonical)}`}
              target="_blank"
              rel="noopener"
              class="share-btn"
              aria-label="Compartir en LinkedIn"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
              </svg>
            </a>
            <a 
              href={`https://wa.me/?text=${encodeURIComponent(post.title + ' ' + canonical)}`}
              target="_blank"
              rel="noopener"
              class="share-btn"
              aria-label="Compartir en WhatsApp"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
            </a>
          </div>
        </div>
      </footer>
    </article>
    
    {relatedPosts.length > 0 && (
      <RelatedPosts posts={relatedPosts} currentCluster={post.pillar} />
    )}
  </main>
  
  <Footer />
</BaseLayout>

<style>
  .post-main {
    padding-top: 64px;
  }
  
  @media (min-width: 768px) {
    .post-main {
      padding-top: 72px;
    }
  }
  
  .post-article {
    max-width: 780px;
    margin: 0 auto;
    padding: 2rem 1.5rem 3rem;
  }
  
  @media (min-width: 768px) {
    .post-article {
      padding: 3rem 1.5rem 4rem;
    }
  }
  
  /* Header */
  .post-header {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border);
  }
  
  .post-header h1 {
    font-size: 2rem;
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 1.5rem;
  }
  
  @media (min-width: 768px) {
    .post-header h1 {
      font-size: 2.5rem;
    }
  }
  
  /* Takeaways */
  .post-takeaways {
    background: var(--gradient-hero);
    border-left: 4px solid var(--primary);
    border-radius: 0 1rem 1rem 0;
    padding: 1.5rem;
    margin: 2rem 0;
  }
  
  .post-takeaways h2 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 0.75rem;
  }
  
  .post-takeaways p {
    color: var(--foreground-muted);
    line-height: 1.7;
    margin: 0;
  }
  
  /* Content */
  .post-content {
    font-size: 1.1rem;
    line-height: 1.8;
  }
  
  .post-content :global(h2) {
    font-size: 1.6rem;
    font-weight: 700;
    margin: 2.5rem 0 1rem;
    scroll-margin-top: 100px;
  }
  
  .post-content :global(h3) {
    font-size: 1.3rem;
    font-weight: 600;
    margin: 2rem 0 0.75rem;
    scroll-margin-top: 100px;
  }
  
  .post-content :global(p) {
    margin-bottom: 1.5rem;
  }
  
  .post-content :global(ul), .post-content :global(ol) {
    margin: 0 0 1.5rem 1.5rem;
  }
  
  .post-content :global(li) {
    margin-bottom: 0.5rem;
  }
  
  .post-content :global(blockquote) {
    border-left: 4px solid var(--accent);
    margin: 1.5rem 0;
    padding: 1rem 1.5rem;
    background: var(--muted);
    border-radius: 0 0.75rem 0.75rem 0;
    font-style: italic;
    color: var(--foreground-muted);
  }
  
  .post-content :global(pre) {
    background: #1f2937;
    color: #e5e7eb;
    padding: 1.5rem;
    border-radius: 0.75rem;
    overflow-x: auto;
    font-size: 0.9rem;
    line-height: 1.6;
    margin: 1.5rem 0;
  }
  
  .post-content :global(code) {
    background: var(--muted);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
  }
  
  .post-content :global(pre code) {
    background: transparent;
    padding: 0;
  }
  
  .post-content :global(img) {
    border-radius: 0.75rem;
    margin: 1.5rem 0;
    max-width: 100%;
    height: auto;
  }
  
  .post-content :global(a) {
    color: var(--primary);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  
  .post-content :global(a:hover) {
    color: var(--accent);
  }
  
  .post-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }
  
  .post-content :global(th), .post-content :global(td) {
    border: 1px solid var(--border);
    padding: 0.75rem 1rem;
    text-align: left;
  }
  
  .post-content :global(th) {
    background: var(--muted);
    font-weight: 600;
  }
  
  /* Footer */
  .post-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
  }
  
  /* Author Box */
  .author-box {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--muted);
    border-radius: 1rem;
    margin-bottom: 2rem;
  }
  
  .author-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }
  
  .author-info {
    flex: 1;
  }
  
  .author-label {
    font-size: 0.75rem;
    color: var(--foreground-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .author-name {
    display: block;
    font-size: 1rem;
    color: var(--foreground);
    margin-top: 0.25rem;
  }
  
  .author-bio {
    font-size: 0.875rem;
    color: var(--foreground-muted);
    margin-top: 0.5rem;
    line-height: 1.5;
  }
  
  /* CTA */
  .post-cta {
    background: linear-gradient(135deg, #2692DC, #746CE6);
    color: white;
    padding: 2rem;
    border-radius: 1rem;
    text-align: center;
    box-shadow: var(--shadow-glow);
    margin-bottom: 2rem;
  }
  
  .post-cta h3 {
    font-size: 1.35rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
  }
  
  .post-cta p {
    opacity: 0.9;
    margin-bottom: 1.25rem;
  }
  
  .cta-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: white;
    color: var(--primary);
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.15s;
  }
  
  .cta-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    color: var(--primary);
  }
  
  /* Share */
  .share-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .share-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--foreground-muted);
  }
  
  .share-buttons {
    display: flex;
    gap: 0.75rem;
  }
  
  .share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--muted);
    color: var(--foreground-muted);
    transition: all 0.15s;
  }
  
  .share-btn:hover {
    background: var(--primary);
    color: white;
  }
</style>